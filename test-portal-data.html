<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Portal Data Loading</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>Portal Data Loading Test</h1>
  <div id="test-results"></div>

  <script>
    const results = document.getElementById('test-results');
    
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      results.appendChild(div);
    }

    async function testPortalDataLoading() {
      log('Starting portal data loading test...');
      
      // First, login
      try {
        const loginResponse = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'test@example.com',
            password: 'password123'
          })
        });
        
        const loginData = await loginResponse.json();
        if (!loginResponse.ok || loginData.error) {
          log('Login failed: ' + (loginData.error || 'Unknown error'), 'error');
          return;
        }
        
        log('Login successful! Token: ' + loginData.accessToken.substring(0, 20) + '...', 'success');
        const token = loginData.accessToken;
        
        // Test each API endpoint
        const endpoints = [
          { name: 'Projects', url: '/api/projects' },
          { name: 'Files', url: '/api/files?folder=/' },
          { name: 'Messages', url: '/api/messages/conversations' },
          { name: 'Invoices', url: '/api/invoices' },
          { name: 'Document Templates', url: '/api/documents/templates' }
        ];
        
        for (const endpoint of endpoints) {
          log(`\nTesting ${endpoint.name} endpoint...`);
          
          try {
            const response = await fetch(endpoint.url, {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            const data = await response.json();
            
            if (response.ok) {
              log(`✓ ${endpoint.name}: ${response.status} OK`, 'success');
              log(`  Data: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
            } else {
              log(`✗ ${endpoint.name}: ${response.status} ${response.statusText}`, 'error');
              log(`  Error: ${JSON.stringify(data)}`, 'error');
            }
          } catch (error) {
            log(`✗ ${endpoint.name}: ${error.message}`, 'error');
          }
        }
        
      } catch (error) {
        log('Test failed: ' + error.message, 'error');
      }
    }
    
    // Run the test
    testPortalDataLoading();
  </script>
</body>
</html>